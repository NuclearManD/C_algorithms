/*
	More complex math operations for f16 fixedpoint
*/

#include "f16_fixedpoint.h"

#define MUL_INLINE(a,b) (((long)(a)) * (b)) >> 16

// e^i = f16_epow_set_0[i]
int f16_epow_set_0[11] = 
	{ 65536, 178145 , 484249 , 1316326 , 3578144 , 9726405 , 26439109 , 71868951 , 195360063 , 531043708 , 1443526462 };
// e^(i/256) = f16_epow_set_1[i]
int f16_epow_set_1[256] =
	{ 65536 , 65793 , 66050 , 66309 , 66568 , 66829 , 67090 , 67353 , 
	67616 , 67881 , 68147 , 68413 , 68681 , 68950 , 69220 , 69491 , 
	69763 , 70036 , 70310 , 70585 , 70861 , 71139 , 71417 , 71697 , 
	71977 , 72259 , 72542 , 72826 , 73111 , 73397 , 73684 , 73972 , 
	74262 , 74553 , 74844 , 75137 , 75431 , 75727 , 76023 , 76321 , 
	76619 , 76919 , 77220 , 77523 , 77826 , 78131 , 78436 , 78743 , 
	79052 , 79361 , 79672 , 79983 , 80296 , 80611 , 80926 , 81243 , 
	81561 , 81880 , 82201 , 82522 , 82845 , 83170 , 83495 , 83822 , 
	84150 , 84479 , 84810 , 85142 , 85475 , 85810 , 86145 , 86483 , 
	86821 , 87161 , 87502 , 87845 , 88188 , 88533 , 88880 , 89228 , 
	89577 , 89928 , 90280 , 90633 , 90988 , 91344 , 91701 , 92060 , 
	92421 , 92782 , 93145 , 93510 , 93876 , 94243 , 94612 , 94983 , 
	95354 , 95728 , 96102 , 96478 , 96856 , 97235 , 97616 , 97998 , 
	98381 , 98766 , 99153 , 99541 , 99930 , 100322 , 100714 , 101108 , 
	101504 , 101901 , 102300 , 102701 , 103103 , 103506 , 103911 , 104318 , 
	104726 , 105136 , 105548 , 105961 , 106375 , 106792 , 107210 , 107629 , 
	108051 , 108473 , 108898 , 109324 , 109752 , 110182 , 110613 , 111046 , 
	111480 , 111917 , 112355 , 112795 , 113236 , 113679 , 114124 , 114571 , 
	115019 , 115469 , 115921 , 116375 , 116831 , 117288 , 117747 , 118208 , 
	118670 , 119135 , 119601 , 120069 , 120539 , 121011 , 121485 , 121960 , 
	122437 , 122917 , 123398 , 123881 , 124365 , 124852 , 125341 , 125831 , 
	126324 , 126818 , 127315 , 127813 , 128313 , 128815 , 129320 , 129826 , 
	130334 , 130844 , 131356 , 131870 , 132386 , 132905 , 133425 , 133947 , 
	134471 , 134997 , 135526 , 136056 , 136589 , 137123 , 137660 , 138199 , 
	138740 , 139283 , 139828 , 140375 , 140925 , 141476 , 142030 , 142586 , 
	143144 , 143704 , 144266 , 144831 , 145398 , 145967 , 146538 , 147112 , 
	147688 , 148266 , 148846 , 149429 , 150013 , 150601 , 151190 , 151782 , 
	152376 , 152972 , 153571 , 154172 , 154775 , 155381 , 155989 , 156600 , 
	157213 , 157828 , 158446 , 159066 , 159688 , 160313 , 160941 , 161571 , 
	162203 , 162838 , 163475 , 164115 , 164757 , 165402 , 166050 , 166700 , 
	167352 , 168007 , 168665 , 169325 , 169987 , 170653 , 171321 , 171991 , 
	172664 , 173340 , 174019 , 174700 , 175383 , 176070 , 176759 , 177451 };

// e^-i = f16_epow_set_n0[i]
int f16_epow_set_n0[11] = 
	{ 65536, 24109, 8869, 3263, 1200, 442, 162, 60, 22, 8, 3 };
// e^(-i/256) = f16_epow_set_1[i]
int f16_epow_set_n1[256] =
	{ 65536, 65280, 65026, 64772, 64520, 64268, 64018, 63768, 
	63520, 63272, 63025, 62780, 62535, 62291, 62048, 61806, 
	61565, 61325, 61086, 60848, 60611, 60375, 60139, 59905, 
	59671, 59439, 59207, 58976, 58746, 58517, 58289, 58062, 
	57835, 57610, 57385, 57162, 56939, 56717, 56496, 56275, 
	56056, 55837, 55620, 55403, 55187, 54972, 54757, 54544, 
	54331, 54119, 53908, 53698, 53489, 53280, 53073, 52866, 
	52660, 52454, 52250, 52046, 51843, 51641, 51440, 51239, 
	51039, 50841, 50642, 50445, 50248, 50052, 49857, 49663, 
	49469, 49276, 49084, 48893, 48702, 48512, 48323, 48135, 
	47947, 47760, 47574, 47389, 47204, 47020, 46836, 46654, 
	46472, 46291, 46110, 45931, 45752, 45573, 45395, 45218, 
	45042, 44867, 44692, 44517, 44344, 44171, 43999, 43827, 
	43656, 43486, 43317, 43148, 42980, 42812, 42645, 42479, 
	42313, 42148, 41984, 41820, 41657, 41495, 41333, 41172, 
	41011, 40851, 40692, 40534, 40376, 40218, 40061, 39905, 
	39750, 39595, 39440, 39286, 39133, 38981, 38829, 38677, 
	38527, 38376, 38227, 38078, 37929, 37781, 37634, 37487, 
	37341, 37196, 37051, 36906, 36762, 36619, 36476, 36334, 
	36192, 36051, 35911, 35771, 35631, 35492, 35354, 35216, 
	35079, 34942, 34806, 34670, 34535, 34400, 34266, 34133, 
	34000, 33867, 33735, 33604, 33473, 33342, 33212, 33083, 
	32954, 32825, 32697, 32570, 32443, 32316, 32190, 32065, 
	31940, 31815, 31691, 31568, 31445, 31322, 31200, 31078, 
	30957, 30836, 30716, 30596, 30477, 30358, 30240, 30122, 
	30005, 29888, 29771, 29655, 29539, 29424, 29310, 29195, 
	29081, 28968, 28855, 28743, 28631, 28519, 28408, 28297, 
	28187, 28077, 27967, 27858, 27750, 27642, 27534, 27426, 
	27319, 27213, 27107, 27001, 26896, 26791, 26687, 26583, 
	26479, 26376, 26273, 26170, 26068, 25967, 25866, 25765, 
	25664, 25564, 25465, 25365, 25266, 25168, 25070, 24972, 
	24875, 24778, 24681, 24585, 24489, 24394, 24298, 24204 };

/*int pow_fp(int x, int exp){
	long val = 65536;
	while (exp-- > 0)
		val = (val * x) >> 16;
	while (exp++ < 0)
		val = (val << 16) / x;
	return val;
}*/

int e_x_fp(int exp){
	long val;

	if (exp > 0){
		if (exp > 681391)
			return (-1);
		val = (((long)f16_epow_set_0[exp >> 16]) * f16_epow_set_1[(exp >> 8)&255]) >> 16;
		val *= (65536 + (exp & 255));
	} else if (exp < 0){
		if (exp < -681391)
			return (-1);
		exp = -exp;
		val = (((long)f16_epow_set_n0[exp >> 16]) * f16_epow_set_n1[(exp >> 8)&255]) >> 16;
		val *= (65536 - (exp & 255));
	} else
		return 65536;
	return val >> 16;
}

int tanh_fp(int a){
	if (a > 681391)
		return 65536;
	else if (a < -681391)
		return -65536;
	int ex = e_x_fp(a);
	long enx = 4294967296L / ex;
	return ((ex - enx) << 16)/(ex + enx);
}
