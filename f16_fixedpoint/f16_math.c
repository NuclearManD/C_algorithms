/*
	More complex math operations for f16 fixedpoint
*/

#include "f16_fixedpoint.h"

// e^i = f16_epow_set_0[i]
int f16_epow_set_0[11] = 
	{ 65536, 178145 , 484249 , 1316326 , 3578144 , 9726405 , 26439109 , 71868951 , 195360063 , 531043708 , 1443526462 };
// e^(i/256) = f16_epow_set_1[i]
int f16_epow_set_1[256] =
	{ 65536 , 65793 , 66050 , 66309 , 66568 , 66829 , 67090 , 67353 , 
	67616 , 67881 , 68147 , 68413 , 68681 , 68950 , 69220 , 69491 , 
	69763 , 70036 , 70310 , 70585 , 70861 , 71139 , 71417 , 71697 , 
	71977 , 72259 , 72542 , 72826 , 73111 , 73397 , 73684 , 73972 , 
	74262 , 74553 , 74844 , 75137 , 75431 , 75727 , 76023 , 76321 , 
	76619 , 76919 , 77220 , 77523 , 77826 , 78131 , 78436 , 78743 , 
	79052 , 79361 , 79672 , 79983 , 80296 , 80611 , 80926 , 81243 , 
	81561 , 81880 , 82201 , 82522 , 82845 , 83170 , 83495 , 83822 , 
	84150 , 84479 , 84810 , 85142 , 85475 , 85810 , 86145 , 86483 , 
	86821 , 87161 , 87502 , 87845 , 88188 , 88533 , 88880 , 89228 , 
	89577 , 89928 , 90280 , 90633 , 90988 , 91344 , 91701 , 92060 , 
	92421 , 92782 , 93145 , 93510 , 93876 , 94243 , 94612 , 94983 , 
	95354 , 95728 , 96102 , 96478 , 96856 , 97235 , 97616 , 97998 , 
	98381 , 98766 , 99153 , 99541 , 99930 , 100322 , 100714 , 101108 , 
	101504 , 101901 , 102300 , 102701 , 103103 , 103506 , 103911 , 104318 , 
	104726 , 105136 , 105548 , 105961 , 106375 , 106792 , 107210 , 107629 , 
	108051 , 108473 , 108898 , 109324 , 109752 , 110182 , 110613 , 111046 , 
	111480 , 111917 , 112355 , 112795 , 113236 , 113679 , 114124 , 114571 , 
	115019 , 115469 , 115921 , 116375 , 116831 , 117288 , 117747 , 118208 , 
	118670 , 119135 , 119601 , 120069 , 120539 , 121011 , 121485 , 121960 , 
	122437 , 122917 , 123398 , 123881 , 124365 , 124852 , 125341 , 125831 , 
	126324 , 126818 , 127315 , 127813 , 128313 , 128815 , 129320 , 129826 , 
	130334 , 130844 , 131356 , 131870 , 132386 , 132905 , 133425 , 133947 , 
	134471 , 134997 , 135526 , 136056 , 136589 , 137123 , 137660 , 138199 , 
	138740 , 139283 , 139828 , 140375 , 140925 , 141476 , 142030 , 142586 , 
	143144 , 143704 , 144266 , 144831 , 145398 , 145967 , 146538 , 147112 , 
	147688 , 148266 , 148846 , 149429 , 150013 , 150601 , 151190 , 151782 , 
	152376 , 152972 , 153571 , 154172 , 154775 , 155381 , 155989 , 156600 , 
	157213 , 157828 , 158446 , 159066 , 159688 , 160313 , 160941 , 161571 , 
	162203 , 162838 , 163475 , 164115 , 164757 , 165402 , 166050 , 166700 , 
	167352 , 168007 , 168665 , 169325 , 169987 , 170653 , 171321 , 171991 , 
	172664 , 173340 , 174019 , 174700 , 175383 , 176070 , 176759 , 177451 };


/*int pow_fp(int x, int exp){
	long val = 65536;
	while (exp-- > 0)
		val = (val * x) >> 16;
	while (exp++ < 0)
		val = (val << 16) / x;
	return val;
}*/

int e_x_fp(int exp){
	int val;

	if (exp > 681391 || exp < -681391)
		return (-1);
	if (exp > 0){
		val = mul_fp(f16_epow_set_0[exp >> 16], f16_epow_set_1[(exp >> 8)&255]);
		val = mul_fp(val, 65536 + (exp & 255));
	} else if (exp < 0){
		exp = -exp;
		val = mul_fp(f16_epow_set_0[exp >> 16], f16_epow_set_1[(exp >> 8)&255]);
		val = div_fp(65536, mul_fp(val, 65536 + (exp & 255)));
	} else
		return 65536;
	return val;
}

int tanh_fp(int a){
	if (a > 681391)
		return 65536;
	else if (a < -681391)
		return -65536;
	int ex = e_x_fp(a);
	int enx = e_x_fp(-a);
	return div_fp(ex - enx, ex + enx);
}
